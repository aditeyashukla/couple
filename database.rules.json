{
  "rules": {
    ".read": false,
    ".write": false,
    "games": {
      "$code": {
        ".read": "$code.matches(/^[0-9]{4}$/)",
        ".write": "$code.matches(/^[0-9]{4}$/) && newData.exists()",
        ".validate": "newData.hasChildren(['status', 'createdAt', 'currentTurn', 'playerA', 'playerB', 'turns'])",
        "status": {
          ".validate": "newData.isString() && newData.val().matches(/^(waiting|active|completed)$/)"
        },
        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },
        "currentTurn": {
          ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 10"
        },
        "playerA": {
          ".validate": "newData.hasChildren(['connected', 'connectedAt', 'lastSeen'])",
          "connected": {
            ".validate": "newData.isBoolean()"
          },
          "connectedAt": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "lastSeen": {
            ".validate": "newData.isNumber() && newData.val() >= newData.parent().child('connectedAt').val()"
          },
          "$other": {
            ".validate": false
          }
        },
        "playerB": {
          ".validate": "newData.hasChildren(['connected', 'connectedAt', 'lastSeen'])",
          "connected": {
            ".validate": "newData.isBoolean()"
          },
          "connectedAt": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "lastSeen": {
            ".validate": "newData.isNumber() && newData.val() >= newData.parent().child('connectedAt').val()"
          },
          "$other": {
            ".validate": false
          }
        },
        "turns": {
          ".validate": "!newData.isString() && !newData.isNumber() && !newData.isBoolean()",
          "$turn": {
            ".validate": "$turn.matches(/^(?:[1-9]|10)$/) && (newData.hasChildren(['playerA']) || newData.hasChildren(['playerB']))",
            "playerA": {
              ".validate": "newData.hasChildren(['word', 'submitted', 'submittedAt'])",
              "word": {
                ".validate": "newData.isString() && newData.val().matches(/^[A-Z]{5}$/)"
              },
              "submitted": {
                ".validate": "newData.isBoolean() && newData.val() == true"
              },
              "submittedAt": {
                ".validate": "newData.isNumber()"
              },
              "feedback": {
                ".validate": "newData.hasChildren(['0', '1', '2', '3', '4'])",
                "0": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "1": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "2": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "3": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "4": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "$other": {
                  ".validate": false
                }
              },
              "$other": {
                ".validate": false
              }
            },
            "playerB": {
              ".validate": "newData.hasChildren(['word', 'submitted', 'submittedAt'])",
              "word": {
                ".validate": "newData.isString() && newData.val().matches(/^[A-Z]{5}$/)"
              },
              "submitted": {
                ".validate": "newData.isBoolean() && newData.val() == true"
              },
              "submittedAt": {
                ".validate": "newData.isNumber()"
              },
              "feedback": {
                ".validate": "newData.hasChildren(['0', '1', '2', '3', '4'])",
                "0": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "1": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "2": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "3": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "4": {
                  ".validate": "newData.isString() && newData.val().matches(/^(green|yellow|grey)$/)"
                },
                "$other": {
                  ".validate": false
                }
              },
              "$other": {
                ".validate": false
              }
            },
            "$other": {
              ".validate": false
            }
          }
        },
        "result": {
          ".validate": "(newData.isString() && (newData.val() == 'win' || newData.val() == 'loss')) || newData.val() == null"
        },
        "winningWord": {
          ".validate": "(newData.isString() && newData.val().matches(/^[A-Z]{5}$/)) || newData.val() == null"
        },
        "completedAt": {
          ".validate": "newData.isNumber() || newData.val() == null"
        },
        "$other": {
          ".validate": false
        }
      }
    }
  }
}
